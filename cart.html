<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your Cart | MyPharmAlly</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- üîó Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBpTbJB6FuxDjrXKmWEzl1WZR9MPvchTbc",
      authDomain: "mypharmally-b87c5.firebaseapp.com",
      projectId: "mypharmally-b87c5",
      storageBucket: "mypharmally-b87c5.firebasestorage.app",
      messagingSenderId: "302027821610",
      appId: "1:302027821610:web:9f2e5eb74d7b5d79e0e953",
      measurementId: "G-LNED3HFPCF"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
</head>
<body>

<!-- üîπ Navbar -->
<header class="navbar">
  <h1>MyPharmAlly</h1>
  <nav>
    <a href="index.html">Home</a>
    <a href="buy-medicines.html">Buy Medicines</a>
    <a href="#" class="active">Cart</a>
  </nav>
</header>

<!-- üõí Cart Section -->
<section class="section-box" style="max-width: 900px;">
  <h2 class="section-heading">Your Cart</h2>
  <div id="cartContainer" class="fade-in"></div>

  <div id="cartSummary" style="text-align:right; margin-top:20px;">
    <h3>Total: ‚Çπ<span id="cartTotal">0</span></h3>
    <button class="btn" onclick="checkout()">Place Order</button>
  </div>
</section>

<!-- ‚úÖ Toast -->
<div id="toast" class="toast">Item removed.</div>

<!-- ‚úÖ Floating Cart Icon -->
<a href="cart.html" class="floating-cart">
  <i class="fas fa-shopping-cart"></i>
  <span class="cart-count" id="cartCount">0</span>
</a>

<!-- ‚úÖ Cart Logic -->
<script>
const medicineData = {
  1: { name: "Paracetamol", price: 30 },
  2: { name: "Metformin", price: 55 },
  3: { name: "Cetrizine", price: 25 },
  4: { name: "Vitamin D3", price: 90 },
  5: { name: "Baby Lotion", price: 120 }
};

let cart = JSON.parse(localStorage.getItem("mypharm_cart")) || {};

function renderCart() {
  const container = document.getElementById("cartContainer");
  container.innerHTML = "";

  if (Object.keys(cart).length === 0) {
    container.innerHTML = "<p>Your cart is empty.</p>";
    document.getElementById("cartSummary").style.display = "none";
    return;
  }

  let total = 0;

  Object.entries(cart).forEach(([id, qty]) => {
    const item = medicineData[id];
    const subtotal = item.price * qty;
    total += subtotal;

    const row = document.createElement("div");
    row.className = "medicine-card";
    row.style.marginBottom = "16px";
    row.innerHTML = `
      <h3>${item.name}</h3>
      <p>Price: ‚Çπ${item.price} x ${qty} = ‚Çπ${subtotal}</p>
      <div class="quantity-control">
        <label>Qty:</label>
        <input type="number" min="1" value="${qty}" onchange="updateQty(${id}, this.value)" />
        <button class="btn secondary" onclick="removeItem(${id})" style="margin-left:10px;">Remove</button>
      </div>
    `;
    container.appendChild(row);
  });

  document.getElementById("cartTotal").textContent = total;
  document.getElementById("cartSummary").style.display = "block";
}

function updateQty(id, value) {
  const qty = Math.max(1, parseInt(value));
  cart[id] = qty;
  localStorage.setItem("mypharm_cart", JSON.stringify(cart));
  renderCart();
  updateFloatingCount();
}

function removeItem(id) {
  delete cart[id];
  localStorage.setItem("mypharm_cart", JSON.stringify(cart));
  renderCart();
  updateFloatingCount();
  showToast("Item removed.");
}

function updateFloatingCount() {
  const totalCount = Object.values(cart).reduce((sum, qty) => sum + qty, 0);
  const badge = document.getElementById("cartCount");
  if (badge) badge.textContent = totalCount;
}

function showToast(msg) {
  const toast = document.getElementById("toast");
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 3000);
}

// ‚úÖ Firebase Checkout (Save to Firestore)
async function checkout() {
  const name = prompt("Enter your name:");
  const email = prompt("Enter your email:");

  if (!name || !email) {
    alert("‚ùå Please provide both name and email.");
    return;
  }

  try {
    await db.collection("orders").add({
      name,
      email,
      cart,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    alert("üéâ Order placed successfully!");
    cart = {};
    localStorage.setItem("mypharm_cart", JSON.stringify(cart));
    renderCart();
    updateFloatingCount();
  } catch (err) {
    console.error("Order failed:", err);
    alert("‚ùå Something went wrong. Please try again.");
  }
}

renderCart();
updateFloatingCount();
</script>

</body>
</html>
